<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>article</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.title {
				margin: 3px 11px 15px 2px;
				color: #6d6d72;
				font-size: 17px;
			}
			
			.mui-table-view-cell {
				padding: 10px;
			}
			
			.mui-table-view .mui-media-object {
				line-height: 52px;
				max-width: 60px;
				height: 52px;
			}
			
			.mui-table-view .mui-card {
				font-size: 14px;
				position: relative;
				overflow: hidden;
				margin: 0px;
			}
			
			.mui-card .mui-card-content-inner {
				position: relative;
				padding: 7px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div id="pullrefresh" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view" id="articlelist">
						<li class="mui-table-view-cell mui-media">
							<a href="view/article/preview.html">
								<img class="mui-media-object mui-pull-left" src="images/shuijiao.jpg">
								<div class="mui-media-body">
									<P class="title">幸福</P>
									<p class="mui-ellipsis">能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>
								</div>
							</a>
						</li>
						<li>
							<div class="mui-card">
								<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url(images/cbd.jpg)"></div>
								<div class="mui-card-content">
									<div class="mui-card-content-inner">
										<p>Posted on January 18, 2016</p>
										<p style="color: #333;">这里显示文章摘要，让读者对文章内容有个粗略的概念...</p>
									</div>
								</div>
								<div class="mui-card-footer">
									<a class="mui-card-link">Like</a>
									<a class="mui-card-link">Read more</a>
								</div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media">
							<a href="view/article/preview.html">
								<img class="mui-media-object mui-pull-left" src="images/shuijiao.jpg">
								<div class="mui-media-body">
									<P class="title">幸福</P>
									<p class="mui-ellipsis">能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>
								</div>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div id="share" class="mui-popover mui-popover-action mui-popover-bottom" style="display: block;">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#">拍照或录像</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture" class=""><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/commonUtil.js"></script>
	<script type="text/template" id='article_item'>
		<li class="mui-table-view-cell mui-media">
			<a href="view/article/preview.html" articleid="$Id$">
				<img class="mui-media-object mui-pull-left" src="$CoverImage$">
				<div class="mui-media-body">
					<P class="title">$ArticleName$</P>
					<p class="mui-ellipsis">$Description$</p>

				</div>
			</a>
		</li>
	</script>
	<script type="text/template" id="article_item_right">
		<li href="view/article/preview.html" articleid="$Id$">
			<a href="view/article/preview.html">
				<img class="mui-media-object mui-pull-right" src="$CoverImage$">
				<div class="mui-media-body">
					$ArticleName$
					<p class="mui-ellipsis">$Description$</p>
				</div>
			</a>
		</li>
	</script>
	<script type="text/template" id="article_item_card">
		<li>
			<a href="view/article/preview.html" articleid="$Id$">
			<div class="mui-card">
				<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url($CoverImage$)"></div>
				<div class="mui-card-content">
					<div class="mui-card-content-inner">
						<p>Posted on January 18, 2016</p>
						<p style="color: #333;">$ArticleName$</p>
					</div>
				</div>
			</div>
			</a>
		</li>
	</script>
	<script>
		mui.init({
			swipeBack: false,
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh
				},
				up: {
					auto: true, //可选,默认false.自动上拉加载一次
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});

		var pageNum = 1;
		var allCount = 0;
		var pageSize = 30;
		var apiPath = "http://api.myautos.cn/api/Article/GetByPage";
		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			pageNum = 1;
			var data = {
				pageNum: pageNum,
				pageSize: pageSize
			}
			commonUtil.sendRequestGet(apiPath, data, function(data) {
				$("#articlelist").html("");
				var list = data.Data;
				for(var i = 0; i < list.length; i++) {
					var item = list[i];
					initItem(item, true);
				}
				pageNum++;
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //参数为true代表没有更多数据了。
			});
		}
		/**
		 * 上拉加载具体业务实现。设置时间戳。只加载最新更新的文章
		 */

		function pullupRefresh() {
			var data = {
				pageNum: pageNum,
				pageSize: pageSize
			}
			commonUtil.sendRequestGet(apiPath, data, function(data) {
				var list = data.Data;
				for(var i = 0; i < list.length; i++) {
					var item = list[i];
					initItem(item, false);
				}
				pageNum++;
				mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
			});
		}

		function initItem(item, isPullDown) {
			var template = $('script[id="article_item"]').html();
			var templateCard = $('script[id="article_item_card"]').html();
			var templateRight = $('script[id="article_item_right"]').html();

			var articleHtmlStr
			if(allCount % 10 == 5) {
				articleHtmlStr = templateCard.temp(item);
			} else {
				articleHtmlStr = template.temp(item);
			}
			if(isPullDown) {
				//下拉刷新，新纪录插到最前面；
				$("#articlelist").append(articleHtmlStr);
			} else {
				$("#articlelist").append(articleHtmlStr);
			}
			allCount++;
		}

		/*
		 * 列表点击事件
		 * */
		var aniShow = "pop-in";
		mui('#articlelist').on('tap', 'a', function() {
			var id = this.getAttribute('href');
			var href = this.href;
			var type = "common"; // this.getAttribute("open-type");
			var articleid = this.getAttribute('articleid');
			//不使用父子模板方案的页面
			if(type == "common") {
				var webview_style = {
					popGesture: "close",

				};
				//侧滑菜单需动态控制一下zindex值；
				if(~id.indexOf('offcanvas-')) {
					webview_style.zindex = 9998;
					webview_style.popGesture = ~id.indexOf('offcanvas-with-right') ? "close" : "none";
				}
				//图标界面需要启动硬件加速
				if(~id.indexOf('icons.html')) {
					webview_style.hardwareAccelerated = true;
				}
				mui.openWindow({
					id: id,
					url: this.href,
					styles: webview_style,
					show: {
						aniShow: aniShow
					},
					waiting: {
						autoShow: false
					},
					extras: {
						articleUrl: "http://m.myautos.cn/Article/Index?id=" + articleid,
						articleid: articleid //扩展参数
					}
				});
			} else if(id && ~id.indexOf('.html')) {
				if(!mui.os.plus || (!~id.indexOf('popovers.html') && mui.os.ios)) {
					mui.openWindow({
						id: id,
						url: this.href,
						styles: {
							popGesture: 'close'
						},
						show: {
							aniShow: aniShow
						},
						waiting: {
							autoShow: false
						}
					});
				} else {
					//TODO  by chb 当初这么设计，是为了一个App中有多个模板，目前仅有一个模板的情况下，实际上无需这么复杂
					//使用父子模板方案打开的页面
					//获得共用模板组
					var template = getTemplate('default');
					//判断是否显示右上角menu图标；
					var showMenu = ~href.indexOf('popovers.html') ? true : false;
					//获得共用父模板
					var headerWebview = template.header;
					//获得共用子webview
					var contentWebview = template.content;
					var title = this.innerText.trim();
					//通知模板修改标题，并显示隐藏右上角图标；
					mui.fire(headerWebview, 'updateHeader', {
						title: title,
						showMenu: showMenu,
						target: href,
						aniShow: aniShow
					});

					if(mui.os.ios || (mui.os.android && parseFloat(mui.os.version) < 4.4)) {
						var reload = true;
						if(!template.loaded) {
							if(contentWebview.getURL() != this.href) {
								contentWebview.loadURL(this.href);
							} else {
								reload = false;
							}
						} else {
							reload = false;
						}
						(!reload) && contentWebview.show();

						headerWebview.show(aniShow, 150);
					}
				}
			}
		});
	</script>

</html>