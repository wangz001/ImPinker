<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>article</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/icons-extra.css" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.title {
				margin: 3px 11px 15px 2px;
				color: #6d6d72;
				font-size: 17px;
			}
			
			.mui-table-view-cell {
				padding: 10px;
			}
			
			.mui-table-view .mui-media-object {
				line-height: 64px;
				max-width: 74px;
				height: 61px;
			}
			
			.mui-card-title p {
				display: block;
				color: #6d6d72;
				font-size: 17px;
				margin-bottom: 5px;
			}
			/*card 样式*/
			
			.mui-table-view .mui-card {
				font-size: 14px;
				position: relative;
				overflow: hidden;
				margin: 0px;
				padding: 5px;
			}
			
			.mui-card-content-inner .userinfo {
				margin-bottom: 1px;
			}
			
			.userinfo em {
				font-size: 13px;
			}
			
			.mui-media-body .viewcount .mui-icon,
			.mui-media-body .viewcount .mui-icon-extra {
				font-size: 13px;
			}
			
			.mui-card-content .viewcount,
			.mui-media-body .viewcount {
				float: right;
			}
			
			.mui-card .mui-card-content-inner {
				position: relative;
				padding: 3px;
			}
			
			.mui-slider-title {
				height: 45px;
				line-height: 45px;
				opacity: 0.5;
				font-size: 18px;
			}
			
			.mui-slider-indicator {
				position: absolute;
				bottom: 12px;
				right: 10px;
				width: 100%;
				text-align: center;
				background: 0 0;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div id="pullrefresh" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="mui-slider">
						<div id="sliderContent" class="mui-slider-group mui-slider-loop">
							<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
							<!--<div class="mui-slider-item mui-slider-item-duplicate">
								<a href="#">
									<img src="images/food.png">
								</a>
							</div>
							<div class="mui-slider-item">
								<a href="#">
									<img src="images/suzuki.png">
									<p class="mui-slider-title">吉姆尼行走滇藏线</p>
								</a>
							</div>
							<div class="mui-slider-item">
								<a href="#">
									<img src="images/datong.png">
								</a>
							</div>
							<div class="mui-slider-item">
								<a href="#">
									<img src="images/jeep.png">
									<p class="mui-slider-title">吉姆尼行走滇藏线</p>
								</a>
							</div>
							<div class="mui-slider-item">
								<a href="#">
									<img src="images/food.png">
								</a>
							</div>
							<div class="mui-slider-item mui-slider-item-duplicate">
								<a href="#">
									<img src="images/suzuki.png">
								</a>
							</div>-->
						</div>
						<div class="mui-slider-indicator mui-text-right">
							<div class="mui-indicator mui-active"></div>
							<div class="mui-indicator"></div>
							<div class="mui-indicator"></div>
						</div>
					</div>
					<ul class="mui-table-view" id="articlelist">
						<!--<li class="mui-table-view-cell mui-media">
							<a href="view/article/preview.html">
								<img class="mui-media-object mui-pull-left" src="images/shuijiao.jpg">
								<div class="mui-media-body">
									<P class="title">幸福</P>
									<p class="mui-ellipsis">能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>
									<p class="userinfo">
										<em class="mui-icon mui-icon-person">bwlang</em>
										<em class="mui-icon-extra mui-icon-extra-phone">2017-07-09</em>
										<span class="viewcount">
										<em class="mui-icon-extra mui-icon-extra-like">10</em>
										<em class="mui-icon mui-icon-compose">23</em>
									</span>
									</p>
								</div>
							</a>
						</li>
						<li>
							<div class="mui-card">
								<div class="mui-card-title">
									<p>这里显示文章摘要，让读者对文章内容有个粗略的概念...</p>
								</div>
								<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url(images/cbd.jpg)"></div>
								<div class="mui-card-content">
									<div class="mui-card-content-inner">
										<p class="userinfo">Posted on January 18, 2016
											<span class="viewcount">
											<em class="mui-icon-extra mui-icon-extra-like">10</em>
											<em class="mui-icon mui-icon-compose">23</em>
											</span>
										</p>
									</div>
								</div>
							</div>
						</li>-->
					</ul>
				</div>
			</div>

		</div>

		<div id="share" class="mui-popover mui-popover-action mui-popover-bottom" style="display: block;">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#">拍照或录像</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture" class=""><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/commonUtil.js"></script>
	<script type="text/javascript" src="js/storageUtil.js"></script>
	<script type="text/template" id='article_item'>
		<li class="mui-table-view-cell mui-media">
			<a href="view/article/preview.html" articleid="$Id$" articlename="$ArticleName$">
				<img class="mui-media-object mui-pull-left" src="$CoverImage$">
				<div class="mui-media-body">
					<P class="title">$ArticleName$</P>
					<p class="mui-ellipsis">$Description$</p>
					<p class="userinfo"><em class="mui-icon mui-icon-person">$UserName$</em>
						<em class="mui-icon-extra mui-icon-extra-phone">$CreateTimeStr$</em>
						<span class="viewcount">
						<em class="mui-icon-extra mui-icon-extra-heart">$VoteCount$</em>
						<em class="mui-icon mui-icon-compose">$CommentCount$</em>
					</span>
				</div>
			</a>
		</li>
	</script>
	<script type="text/template" id="slide_item_a">
		<div class="mui-slider-item mui-slider-item-duplicate">
			<a href="view/article/preview.html" articleid="$Id$" articlename="$ArticleName$">
				<img src="$CoverImage$">
				<p class="mui-slider-title">$ArticleName$</p>
			</a>
		</div>
	</script>
	<script type="text/template" id="slide_item_b">
		<div class="mui-slider-item">
			<a href="view/article/preview.html" articleid="$Id$" articlename="$ArticleName$">
				<img src="$CoverImage$">
				<p class="mui-slider-title">$ArticleName$</p>
			</a>
		</div>
	</script>
	<script type="text/template" id="article_item_card">
		<li>
			<a href="view/article/preview.html" articleid="$Id$" articlename="$ArticleName$">
				<div class="mui-card">
					<div class="mui-card-title">
						<p>$ArticleName$</p>
					</div>
					<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url($CoverImage$)"></div>
					<div class="mui-card-content">
						<div class="mui-card-content-inner">
							<p class="userinfo">
								<em class="mui-icon mui-icon-person">$UserName$ 发表于 $CreateTimeStr$</em>
								<span class="viewcount">
									<em class="mui-icon-extra mui-icon-extra-heart">$VoteCount$</em>
									<em class="mui-icon mui-icon-compose">$CommentCount$</em>
								</span></p>
						</div>
					</div>
				</div>
			</a>
		</li>
	</script>
	<script>
		mui.init({
			swipeBack: false,
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					auto: true, //可选,默认false.自动上拉加载一次
					callback: pulldownRefresh
				},
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});
		mui.plusReady(function() {
			//填充轮播图内容
			initSlide();
			//显示文章缓存
			var articleData = storageUtil.getFirstPageArticle();
			if(articleData != null && articleData.length > 0) {
				for (var i=0;i<articleData.length;i++) {
					initItem(articleData[i],true);
				}
			}
			
		});
		
		
		var allArticles = new Array();
		var pageNum = 1;
		var allCount = 0;
		var pageSize = 30;
		var apiPath = "http://api.myautos.cn/api/Article/GetByPage";
		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			allArticles = [];
			pageNum = 1;
			var data = {
				pageNum: pageNum,
				pageSize: pageSize
			}
			commonUtil.sendRequestGet(apiPath, data, function(data) {
				if(data.IsSuccess == 1 && data.Data != null) {
					$("#articlelist").html("");
					var list = data.Data;
					for(var i = 0; i < list.length; i++) {
						var item = list[i];
						initItem(item, true);
					}
					storageUtil.setFirstPageArticle(list);
					pageNum++;
				} else {
					mui.toast(data.Description);
				}
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //参数为true代表没有更多数据了。
			});
		}
		/**
		 * 上拉加载具体业务实现。设置时间戳。只加载最新更新的文章
		 */
		function pullupRefresh() {
			var data = {
				pageNum: pageNum,
				pageSize: pageSize
			}
			commonUtil.sendRequestGet(apiPath, data, function(data) {
				if(data.IsSuccess == 1 && data.Data != null) {
					var list = data.Data;
					for(var i = 0; i < list.length; i++) {
						var item = list[i];
						initItem(item, false);
					}
					pageNum++;
				} else {
					mui.toast(data.Description);
				}
				mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
			});
		}

		function initItem(item, isPullDown) {
			var img_600style = 'style/weibo_600';
			var img_24style = 'style/articlecover_36_24';
			allArticles.push(item);
			var template = $('script[id="article_item"]').html();
			var templateCard = $('script[id="article_item_card"]').html();
			var articleHtmlStr;
			if(allCount % 10 == 5) {
				item.CoverImage = item.CoverImage.replace(img_24style, img_600style);
				//console.log(JSON.stringify(item));
				articleHtmlStr = templateCard.temp(item);
			} else {
				articleHtmlStr = template.temp(item);
			}
			if(isPullDown) {
				//下拉刷新，新纪录插到最前面；
				$("#articlelist").append(articleHtmlStr);
			} else {
				$("#articlelist").append(articleHtmlStr);
			}
			allCount++;
		}

		//显示轮播图内容
		function initSlide() {
			//先显示本地缓存的数据
			var sliderData = storageUtil.getSliderData();
			if(sliderData != null && sliderData.length > 0) {
				initHtml(sliderData);
			}

			//获取最新数据
			var slidePath = 'http://api.myautos.cn/api/Article/GetSlideArticle';
			var para = {};
			commonUtil.sendRequestGet(slidePath, para, function(data) {
				if(data.IsSuccess == 1 && data.Data != null) {
					initHtml(data.Data);
					//更新本地缓存数据
					storageUtil.setSliderData(data.Data);
				}
			});

			//显示轮播图
			function initHtml(list) {
				$("#sliderContent").html("");
				var template_a = $('script[id="slide_item_a"]').html();
				var template_b = $('script[id="slide_item_b"]').html();
				var aTopStr = template_a.temp(list[list.length - 1]);
				$("#sliderContent").append(aTopStr);
				for(var i = 0; i < list.length; i++) {
					var item = list[i];
					var tempStr = template_b.temp(item);
					$("#sliderContent").append(tempStr);
				}
				var aBottomStr = template_a.temp(list[0]);
				$("#sliderContent").append(aBottomStr);
				//获得slider插件对象
				var gallery = mui('.mui-slider');
				gallery.slider({
					interval: 5000 //自动轮播周期，若为0则不自动播放，默认为0；
				});
			}
		}

		/*
		 * 列表点击事件
		 * */
		var aniShow = "pop-in";
		var previewPage = null;
		mui('#articlelist,#sliderContent').on('tap', 'a', function() {
			var id = this.getAttribute('href');
			var href = this.href;
			var type = "common"; // this.getAttribute("open-type");
			var articleid = this.getAttribute('articleid');
			var articlename = this.getAttribute('articlename');

			//不使用父子模板方案的页面
			if(type == "common") {
				var webview_style = {
					popGesture: "close",
				};
				//侧滑菜单需动态控制一下zindex值；
				if(~id.indexOf('offcanvas-')) {
					webview_style.zindex = 9998;
					webview_style.popGesture = ~id.indexOf('offcanvas-with-right') ? "close" : "none";
				}
				//图标界面需要启动硬件加速
				if(~id.indexOf('icons.html')) {
					webview_style.hardwareAccelerated = true;
				}
				//打开详情页面            
				mui.openWindow({
					id: id,
					url: this.href,
					styles: webview_style,
					show: {
						aniShow: aniShow
					},
					waiting: {
						autoShow: false
					},
					extras: {
						articleUrl: "http://m.myautos.cn/Article/Index?id=" + articleid,
						articleid: articleid, //扩展参数
						articlename: articlename
					}
				});
			} else if(id && ~id.indexOf('.html')) {
				if(!mui.os.plus || (!~id.indexOf('popovers.html') && mui.os.ios)) {
					mui.openWindow({
						id: id,
						url: this.href,
						styles: {
							popGesture: 'close'
						},
						show: {
							aniShow: aniShow
						},
						waiting: {
							autoShow: false
						}
					});
				} else {
					//TODO  by chb 当初这么设计，是为了一个App中有多个模板，目前仅有一个模板的情况下，实际上无需这么复杂
					//使用父子模板方案打开的页面
					//获得共用模板组
					var template = getTemplate('default');
					//判断是否显示右上角menu图标；
					var showMenu = ~href.indexOf('popovers.html') ? true : false;
					//获得共用父模板
					var headerWebview = template.header;
					//获得共用子webview
					var contentWebview = template.content;
					var title = this.innerText.trim();
					//通知模板修改标题，并显示隐藏右上角图标；
					mui.fire(headerWebview, 'updateHeader', {
						title: title,
						showMenu: showMenu,
						target: href,
						aniShow: aniShow
					});

					if(mui.os.ios || (mui.os.android && parseFloat(mui.os.version) < 4.4)) {
						var reload = true;
						if(!template.loaded) {
							if(contentWebview.getURL() != this.href) {
								contentWebview.loadURL(this.href);
							} else {
								reload = false;
							}
						} else {
							reload = false;
						}
						(!reload) && contentWebview.show();

						headerWebview.show(aniShow, 150);
					}
				}
			}
		});
	</script>

</html>