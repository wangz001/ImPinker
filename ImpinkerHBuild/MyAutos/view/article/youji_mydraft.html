<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/icons-extra.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/weibo.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">草稿</h1>
			<button id="submit" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">完成</button>
		</header>

		<div id="pullrefresh" class="mui-content mui-scroll-wrapper ">
			<div class="mui-scroll">
				<ul class="mui-table-view" id="draftlist">
					<li class="mui-table-view-cell mui-media">
						<div class="mui-slider-right mui-disabled">
							<a class="mui-btn mui-btn-red">删除</a>
						</div>
						<div class="mui-slider-handle">
							<a href="view/article/preview.html">
								<img class="mui-media-object mui-pull-left" src="images/shuijiao.jpg">
								<div class="mui-media-body">
									幸福
									<p class="mui-ellipsis">能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>
								</div>
							</a>
						</div>
					</li>
				</ul>
			</div>
		</div>

		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/commonUtil.js"></script>
		<script type='text/template' id='draftlistitem'>
			<li class="mui-table-view-cell mui-media">
				<div class="mui-slider-right mui-disabled">
					<a articleid="$Id$" class="mui-btn mui-btn-red">删除</a>
				</div>
				<div class="mui-slider-handle">
					<a articleid="$Id$" href="youji_new.html">
						<img class="mui-media-object mui-pull-left" src="$CoverImage$">
						<div class="mui-media-body">
							$ArticleName$
							<p class="mui-ellipsis">$Description$</p>
						</div>
					</a>
				</div>
			</li>
		</script>
		<script>
			mui.plusReady(function() {
				mui.init({
					swipeBack: false,
					pullRefresh: {
						container: '#pullrefresh',
						up: {
							auto: true, //可选,默认false.自动上拉加载一次
							contentrefresh: '正在加载...',
							callback: pullupRefresh
						}
					}

				});
			});
			(function(mm) {
				var btnArray = ['确认', '取消'];
				$('#draftlist').on('tap', '.mui-btn', function(event) {
					var elem = this;
					var li = elem.parentNode.parentNode;
					mui.confirm('确认删除该条记录？', 'Hello MUI', btnArray, function(e) {
						if(e.index == 0) {
							var articleId = $(elem).attr("articleid");
							console.log(articleId);
							deleteArticle(articleId,function(err){
								console.log(err);
							})
							li.parentNode.removeChild(li);
						} else {
							setTimeout(function() {
								mm.swipeoutClose(li);
							}, 0);
						}
					});
				});
			})(mui);

			var deleteArticle = function(articleid, callback) {
				callback = callback || $.noop;
				var url = 'http://api.myautos.cn/api/article/DeleteArticle';
				var data = {
					Id: articleid
				}
				commonUtil.sendRequestWithToken(url, data, true, function(data) {
					console.log(JSON.stringify(data));
					if(data.IsSuccess == 1 && data.Data != null && data.Data.length > 0) {
						return callback();
					} else {
						return callback(data.Description);
					}
				});
			}
			//添加列表项的点击事件  
			mui('.mui-scroll').on('tap', 'a', function(e) {
				var articleid = $(this).attr("articleid");
				mui.openWindow({
					id: 'youji_new',
					url: 'youji_new.html',
					show: {
						aniShow: "pop-in"
					},
					extras: {
						articleid: articleid //扩展参数
					}
				});
			});
			var pageNum = 1;
			var pageSize = 10;
			var count = 0;
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				var url = 'http://api.myautos.cn/api/article/GetMyDraft';
				commonUtil.sendRequestWithToken(url, {}, true, function(data) {
					console.log(JSON.stringify(data));
					if(data.IsSuccess == 1 && data.Data != null && data.Data.length > 0) {
						var list = data.Data;
						var ul = $('#draftlist');
						for(var i = 0; i < list.length; i++) {
							var item = list[i];
							var imgTemplate = $('script[id="draftlistitem"]').html();
							var imgHtmlStr = imgTemplate.temp(item);
							ul.append(imgHtmlStr);
						}
					} else {
						mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
						return;
					}
					pageNum++;
					mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
				});
			}
		</script>

	</body>

</html>