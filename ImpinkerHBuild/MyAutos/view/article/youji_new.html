<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/icons-extra.css" rel="stylesheet" />
		<style>
			textarea {
				border: 0;
				background-color: transparent;
				/*scrollbar-arrow-color:yellow;  
    scrollbar-base-color:lightsalmon;  
    overflow: hidden;*/
				grid-auto-rows: inherit;
				color: #666464;
				height: auto;
			}
			
			img {
				width: 100%;
			}
			
			.mui-content-padded {
				background-color: white;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">写游记</h1>
			<button id="publishyouji" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">发布</button>
		</header>
		<div class="mui-content">
			<div class="mui-input-group">
				<div class="mui-input-row">
					<input id="youi_title" type="text" placeholder="帖子标题">
				</div>
			</div>
			<div>
				<a id='setcoverimage'>点击设置封面图</a>
				<img id='coverimage' src='../../images/cbd.jpg'>
			</div>
			<div class="mui-content-padded">

				<div id="youji_content" class="mui-input-row">
					<textarea name='yjcontent' placeholder="试试添加微博内容，秒速发游记..."></textarea>
				</div>
			</div>
		</div>
		<footer class="mui-bar mui-bar-footer">
			<a id="selectWeibo"><span class="mui-icon-extra mui-icon-extra-new"></span></a>
			<a id='addimage'><span class="mui-icon mui-icon-image"></span></a>
			<a id="share"><span class="mui-icon mui-icon-paperplane"></span></a>
			<a id="preview_btn"><span class="mui-icon mui-icon-search">预览</span></a>
			<a><span class="mui-icon mui-icon-arrowright">排序</span></a>
		</footer>
		<script src="../../js/mui.js"></script>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/article/youji_new.js"></script>
		<script type="text/javascript" src="../../js/commonUtil.js"></script>

		<script type="application/javascript">
			mui.init({});
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var selectedWeibos = self.items;
				if(selectedWeibos != null) {
					//在页面上展示
					edityoujiUtil.showWeiBoItems(contentLists, selectedWeibos);
				}
			});

			var contentLists = new Array();
			var articleid = 0;
			$("#youi_title").blur(function() {
				var content = $(this).val();
				console.log(content);
				if(content == "") return;
				//创建文章或更新标题
				setTimeout(function() {
					if(articleid == 0) {
						edityoujiUtil.createYouji(content, function(id) {
							if(id != null && id > 0) {
								console.log(id);
								articleid = id;
							}
						});
					} else {
						edityoujiUtil.updateTitle(content);
					}
				}, 500);
			});
			//保存草稿
			$("#youji_content textarea").change(function() {
				setTimeout(function() {
					if(articleid > 0) {
						var resultStr = edityoujiUtil.getcontenthtml('yjcontent');
						console.log("保存草稿！" + resultStr);
						edityoujiUtil.saveDraft(articleid, resultStr, function(data) {
							console.log("保存草稿成功！");
						});
					} else {
						edityoujiUtil.createYouji("草稿" + (new Date().toLocaleString()), function(id) {
							if(id != null && id > 0) {
								console.log(id);
								articleid = id;
								console.log(articleid);
							}
						});
					}
				}, 2000);
			});
			//设置封面图
			document.getElementById('setcoverimage').addEventListener('tap', function() {
				edityoujiUtil.setCoverimage();
			});
			//发布
			document.getElementById('publishyouji').addEventListener('tap', function() {
				setTimeout(function() {
					if(articleid > 0) {
						var resultStr = edityoujiUtil.getcontenthtml('yjcontent');
						if(resultStr == "") return;
						console.log("发布！");
						edityoujiUtil.publishYouji(articleid, resultStr, function(data) {
							console.log("发布成功！" + data);
							plus.webview.getLaunchWebview().reload();
							setTimeout(function() {
								mui.back();
							}, 500);
						});
					}
				}, 500);
			});
			
			//添加图片
			document.getElementById('addimage').addEventListener('tap', function() {
				edityoujiUtil.addImage(articleid,function(data){
					var imgPath = 'http://img.myautos.cn/';
					var imgHtmlStr='<p name="yjcontent"><img src="' + imgPath + data.Data + '"></p>';
					$(".mui-content-padded").append(imgHtmlStr);
				});
			});
			//添加微博
			document.getElementById('selectWeibo').addEventListener('tap', function() {
				mui.openWindow({
					url: "youji_new_selectweibo.html",
					id: "youji_new_selectweibo",
					createNew: true,
					show: {
						aniShow: 'slide-in-right',
						duration: 200
					}
				});
			});
			//预览
			document.getElementById('preview_btn').addEventListener('tap', function() {
				var resultStr = edityoujiUtil.getcontenthtml('yjcontent');
				mui.openWindow({
					url: "youji_preview.html",
					id: "youji_preview",
					createNew: true,
					show: {
						aniShow: 'slide-in-right',
						duration: 200
					},
					extras: {
						contentStr: resultStr
					},
				});
			});
		</script>
	</body>

</html>