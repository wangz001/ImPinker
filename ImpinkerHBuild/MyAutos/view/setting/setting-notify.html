<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/setting/notify.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">消息</h1>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll">
						<a class="mui-control-item mui-active" href="#item1mobile">
							新通知
						</a>
						<a class="mui-control-item" href="#item2mobile">
							全部
						</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view" id="mui-table-view-1">

								</ul>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view" id="mui-table-view-2">
									<!--<li class="mui-table-view-cell">
										<div class="info-rows-2">
											<div class="info-box-2">
												<div class="img-box">
													<img src="../../images/logo1.png">
												</div>
												<div class="content noread">
													<div class="panel">
														<div class="wrap">
															<h6><em class="icon-red">New</em> 直播小张</h6>
															<p>北京未实名认证的手机卡被分批实施单向停</p>
															<strong class="date">3分钟前</strong>
														</div>
													</div>
												</div>
											</div>
										</div>
									</li>
									<li class="mui-table-view-cell">
										<div class="info-rows-2">
											<div class="info-box-2">
												<div class="img-box">
													<img src="../../images/logo1.png">
												</div>
												<div class="content">
													<div class="panel">
														<div class="wrap">
															<h6>直播小张</h6>
															<p>北京未实名认证的手机卡被分批实施单向停</p>

															<strong class="date">3分钟前</strong>
														</div>
													</div>
												</div>
											</div>
										</div>
									</li>-->
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/commonUtil.js"></script>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script type="text/template" id="notifyitem">
			<li class="mui-table-view-cell">
				<div class="info-rows-2" targettype="$TargetType$" targetid="$Target$" notifyid="$Id$">
					<div class="info-box-2">
						<div class="img-box">
							<img src="$SenderHeadUrl$">
						</div>
						<div class="content">
							<div class="panel">
								<div class="wrap">
									<h6>$SenderName$ $ActionName$ 你的 $TargetTypeName$ 《$TargetName$》</h6>
									<p>$ContentStr$</p>
									<strong class="date">$CreateTime$</strong>
								</div>
							</div>
						</div>
					</div>
				</div>
			</li>
		</script>
		<script type="text/template" id="notifyitem-noread">
			<li class="mui-table-view-cell">
				<div class="info-rows-2" targettype="$TargetType$" targetid="$Target$" notifyid="$Id$">
					<div class="info-box-2">
						<div class="img-box">
							<img src="$SenderHeadUrl$">
						</div>
						<div class="content noread">
							<div class="panel">
								<div class="wrap">
									<h6><em class="icon-red">New</em> $SenderName$ $ActionName$ 你的 $TargetTypeName$ 《$TargetName$》</h6>
									<p>$ContentStr$</p>
									<strong class="date">$CreateTime$</strong>
								</div>
							</div>
						</div>
					</div>
				</div>
			</li>
		</script>
		<script>
			mui.init();

			mui.plusReady(function() {
				//阻尼系数
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
				//默认加载第一页
				getNotify(function(data) {
				});
				getAllNotify(function(data) {
				});

				mui("#item1mobile .mui-scroll").pullToRefresh({
					up: {
						callback: function() {
							var self = this;
							getNotify(function(data) {
								self.endPullUpToRefresh(true);
							});
						}
					}
				});
				mui("#item2mobile .mui-scroll").pullToRefresh({
					up: {
						callback: function() {
							var self = this;
							getAllNotify(function(data) {
								if(data.IsSuccess == 1 && data.Data != null) {
									self.endPullUpToRefresh();
								} else {
									self.endPullUpToRefresh(true);
								}
							});
						}
					}
				});
			});
		</script>
		<script type="text/javascript">
			///获取通知。 isnew=1时，表示获取新通知；isnew=0表示获取全部
			function getNotify(callback) {
				callback = callback || $.noop;
				var url = "http://api.myautos.cn/api/Notify/GetNewNotifyList";
				var data = {
					isread: 1
				};
				commonUtil.sendRequestWithToken(url, data, false, function(data) {
					if(data.IsSuccess == 1 && data.Data != null) {
						var list = data.Data;
						var template_notifyitem = $('script[id="notifyitem-noread"]').html();
						for(var i = 0; i < list.length; i++) {
							var item = list[i];
							var tempStr = template_notifyitem.temp(item);
							$("#mui-table-view-1").append(tempStr);
						}
					}
					return callback(data);
				});
			}

			///获取所有通知。分页
			var allNotifyPage = 1;
			var allNotifyPageSize = 15;
			function getAllNotify(callback) {
				callback = callback || $.noop;
				var url = "http://api.myautos.cn/api/Notify/GetAllNotifyList";
				var data = {
					page: allNotifyPage,
					pagesize: allNotifyPageSize
				};
				commonUtil.sendRequestWithToken(url, data, false, function(data) {
					if(data.IsSuccess == 1 && data.Data != null) {
						var list = data.Data;
						var template_notifyitem = $('script[id="notifyitem"]').html();
						var template_notifyitem_noread = $('script[id="notifyitem-noread"]').html();
						for(var i = 0; i < list.length; i++) {
							var item = list[i];
							var tempStr = "";
							if(item.IsRead == 1) {
								tempStr = template_notifyitem.temp(item);
							} else {
								tempStr = template_notifyitem_noread.temp(item);
							}
							$("#mui-table-view-2").append(tempStr);
						}
						allNotifyPage++;
					} else {
						mui.toast("没有更多数据");
					}
					return callback(data);
				});
			}

			mui('.mui-content .mui-control-content').on('tap', '.info-rows-2', function() {
				var targettype = this.getAttribute('targettype');
				var targetid = this.getAttribute('targetid');
				var notifyid = this.getAttribute('notifyid');
				console.log(targettype);
				//标记为已读
				markRead(notifyid);
				//$(this).remove();
				if(targettype == 1) {
					mui.openWindow({
						id: targetid,
						url: "../article/preview.html",
						show: {
							aniShow: "pop-in"
						},
						waiting: {
							autoShow: false
						},
						extras: {
							articleid: targetid, //扩展参数
							articlename: ""
						}
					});
				}
				if(targettype == 2) {
					mui.openWindow({
						id: targetid,
						url: "../weibo/weibo_preview.html",
						show: {
							aniShow: "pop-in"
						},
						waiting: {
							autoShow: false
						},
						extras: {
							weiboid: targetid //扩展参数
						}
					});
				}
			});
			//标记为已读
			function markRead(targetid) {
				var url = "http://api.myautos.cn/api/Notify/UpdateNotifyState";
				var data = {
					NotifyId: targetid,
					IsRead: 1
				};
				commonUtil.sendRequestWithToken(url, data, true, function(data) {
					console.log(JSON.stringify(data));
				});
			}
		</script>
	</body>

</html>