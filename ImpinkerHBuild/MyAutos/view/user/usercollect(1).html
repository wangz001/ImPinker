<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的收藏</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/icons-extra.css" />
		<link href="../../css/user/userindex.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/weibo.css" />
		<link rel="stylesheet" href="../../css/imageviewer.css" />
		<style type="text/css">
			#pullrefresh {
				/*margin-top: 50px;*/
			}
			
			.mui-card-header.mui-card-media img {
				border-radius: 22px;
			}
			
			.mui-card-header {
				position: static;
			}
			
			.mui-card .mui-card-footer {
				padding: 4px 10px;
				min-height: 30px;
			}
			
			.userinfo em {
				font-size: 13px;
				max-width: 70%;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			
			.collecttime {
				position: absolute;
				top: 25%;
				right: 6px;
				width: 74px;
				height: 30px;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">我的收藏</h1>
		</header>
		<div class="mui-content">
			<div id="pullrefresh" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view" id="cardlist">
						<!--<li class="card-article">
							<div class="mui-card">
								<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url(../../images/cbd.jpg)"></div>
								<div class="mui-card-content">
									<div class="mui-card-content-inner">
										<p class="userinfo">
											<em class="mui-icon mui-icon-person">UserName 发表于发表于发表于发表于发表于发表于发表于 CreateTimeStr</em>
											<span class="collecttime">15454551</span>
										</p>
									</div>
								</div>
							</div>
						</li>
						<li class="card-weibo1">
							<div class="mui-card">
								<div class="mui-card-header mui-card-media">
									<img class="head-img" src="../../images/logo.png">
									<div class="mui-media-body">
										<em class="mui-icon mui-icon-person">bwlang</em>
										<p>发表于 2016-06-30 15:30</p>
									</div>
								</div>
								<div class="mui-card-content">
									<p>的空间疯狂的健康</p>
									<div class="media-pic-list">
										<ul>
											<li>
												<img src="../../images/login-1.png" data-preview-src="" data-preview-group="1">
											</li>
											<li>
												<img src="../../images/muwu.jpg" data-preview-src="" data-preview-group="1">
											</li>
										</ul>
									</div>
								</div>
								<div class="mui-card-footer ">
									<span class="collecttime">2016/11/23</span>
								</div>
							</div>
						</li>-->
					</ul>
				</div>
			</div>

		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/mui.pullToRefresh.js"></script>
		<script type="text/javascript" src="../../js/mui.pullToRefresh.material.js"></script>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/mui.zoom.js"></script>
		<script type="text/javascript" src="../../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../../js/commonUtil.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/template" id="card-article">
			<li class="card-article" articleid="$Id$">
				<div class="mui-card">
					<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url($CoverImage$)"></div>
					<div class="mui-card-content">
						<div class="mui-card-content-inner">
							<p class="userinfo">
								<p class="userinfo">
									<em class="mui-icon">$ArticleName$</em>
									<span class="collecttime">$collectTime$</span>
								</p>
								</span>
							</p>
						</div>
					</div>
				</div>
			</li>
		</script>
		<script type="text/template" id="card-weibo">
			<li class="card-weibo" weiboid="$Id$">
				<div class="mui-card">
					<div class="mui-card-header mui-card-media">
						<img class="head-img" userid="$UserId$" src="$UserHeadImage$">
						<div class="mui-media-body">
							<em class="mui-icon mui-icon-person">$UserName$</em>
							<p>发表于 $PublishTime$</p>
						</div>
					</div>
					<div class="mui-card-content">
						<p>$Description$</p>
						<div class="media-pic-list">
							$imglist$
						</div>
					</div>
					<div class="mui-card-footer">
						<span class="collecttime">$collectTime$</span>
					</div>
				</div>
			</li>
		</script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true,
				pullRefresh: {
					container: '#pullrefresh',
					up: {
						contentrefresh: '正在加载...',
						auto: true,
						contentnomore: '没有更多数据了',
						callback: pullupRefresh
					}
				}
			});
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var userid = self.userid;
				getUserinfo(userid);
			});
			mui.previewImage();

			function pullupRefresh() {
				getAllList()

			}

			function getAllList() {
				//console.log(JSON.stringify(currentParamEntity));
				var url = 'http://api.myautos.cn/api/usercollection/GetMyCollect';
				var data = {
					pageNum: 1,
					pagesize: 30
				};
				commonUtil.sendRequestWithToken(url, data, false, function(data) {
					if(data.IsSuccess == 1 && data.Data != null && data.Data.length > 0) {
						var list = data.Data;
						for(var i = 0; i < list.length; i++) {
							var item = list[i];
							if(item.EntityType == 1) {
								var article = item.ArticleVm;
								article.collectTime = item.CreateTime.substring(0, 10);
								initCard(1, article);
							}
							if(item.EntityType == 2) {
								var weibo = item.WeiboVm;
								weibo.collectTime = item.CreateTime.substring(0, 10);
								initCard(2, weibo);
							}
						}
					} else {
						mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
						return;
					}
					mui('#pullrefresh').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
				});
			}

			var img_1200style = 'style/weibo_1200';
			var img_600style = 'style/weibo_600';
			var img_24style = 'style/weibo_24_16';
			var img_36style = 'style/weibo_36_24';
			var articleTemplate = $('script[id="card-article"]').html();
			var weiboTemplate = $('script[id="card-weibo"]').html();
			///填充内容
			function initCard(entityType, item) {
				if(entityType == 1) {
					var article = item;
					article.CoverImage = article.CoverImage.replace("style/articlecover_36_24", "style/weibo_600")
					var imgHtmlStr = articleTemplate.temp(article);
					$("#cardlist").append(imgHtmlStr);
				}

				if(entityType == 2) {
					var weibo = item;
					var imgHtmlStr = "";
					var imgs = weibo.ContentValue.split(',');
					if(imgs.length > 1) {
						//多图
						imgHtmlStr += "<ul>";
						for(var j = 0; j < imgs.length; j++) {
							imgHtmlStr += '<li><img src="' + imgs[j] + '" data-preview-src="' + imgs[j].replace(img_24style, img_1200style) + '" data-preview-group="' + weibo.Id + '"></li>';
						}
						imgHtmlStr += "</ul>";
					} else {
						imgHtmlStr = '<img src="' + imgs[0].replace(img_24style, img_36style) + '" class="bigimage" data-preview-src="' + imgs[0].replace(img_24style, img_1200style) + '" data-preview-group="' + item.Id + '">';
					}
					weibo.imglist = imgHtmlStr;
					//显示地理位置
					//					weibo.cardlocation = "";
					//					if(weibo.LocationText != "" && weibo.Longitude != "" && weibo.Lantitude != "") {
					//						var lbsStr = "<div weiboid='" + weibo.Id + "' class='card-location'><span class='mui-icon mui-icon-location'></span><span>" + weibo.LocationText + "</span></div>";
					//						weibo.cardlocation = lbsStr;
					//					}
					var cardStr = weiboTemplate.temp(weibo);
					$("#cardlist").append(cardStr);
				}
			}

			//

			function getUserinfo() {

			}
		</script>
		<script type="text/javascript">
			//跳转 
			mui('#cardlist').on('tap', '.mui-card-header', function() {
				var liTag = $(this).closest("li");
				var cardType = $(liTag).attr("class");
				if("card-weibo" == cardType) {
					var weiboid = $(liTag).attr("weiboid");
					mui.openWindow({
						url: "../weibo/weibo_preview.html",
						id: "weibo_preview",
						extras: {
							weiboid: weiboid
						},
						show: {
							aniShow: 'slide-in-right',
							duration: 200
						}
					});
				}
				if("card-article" == cardType) {
					var articleid = $(liTag).attr("articleid");
					mui.openWindow({
						url: "../article/preview.html",
						id: "preview",
						extras: {
							articleid: articleid
						},
						show: {
							aniShow: 'slide-in-right',
							duration: 200
						}
					});
				}

			});
		</script>
	</body>

</html>