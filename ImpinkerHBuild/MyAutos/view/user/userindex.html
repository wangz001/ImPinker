<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>用户主页</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/icons-extra.css" />
		<link href="../../css/user/userindex.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/weibo.css" />
		<link rel="stylesheet" href="../../css/imageviewer.css" />
		<style type="text/css">
			#scroll1 .mui-card-header>img:first-child {
				font-size: 0;
				line-height: 0;
				float: left;
				width: 34px;
				height: 34px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">
			</h1>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll">
						<a class="mui-control-item mui-active" href="#item1mobile">
							途迹
						</a>
						<a class="mui-control-item" href="#item2mobile">
							游记
						</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="personal-top" style="background-image: url(../../images/cbd.jpg);">
									<div class="head-img"><img src="../../images/food.png">
									</div>
									<div class="username">
										<!--<h4>Bwlang星</h4>-->
									</div>
								</div>
								<ul class="mui-table-view" id="mui-table-view-1">
									<li class="card-article">
										<div class="mui-card">
											<div class="mui-card-title">
												<p>这里显示文章摘要，让读者对文章内容有个粗略的概念...</p>
											</div>
											<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url(../../images/cbd.jpg)"></div>
											<div class="mui-card-content">
												<div class="mui-card-content-inner">
													<p class="userinfo">Posted on January 18, 2016
														<span class="viewcount">
											<em class="mui-icon-extra mui-icon-extra-like">10</em>
											<em class="mui-icon mui-icon-compose">23</em>
											</span>
													</p>
												</div>
											</div>
										</div>
									</li>
									<li class="card-weibo1">
										<div class="mui-card">
											<div class="mui-card-header mui-card-media">
												<img class="head-img" src="../../images/logo.png">
												<div class="mui-media-body">
													<em class="mui-icon mui-icon-person">bwlang</em>
													<p>发表于 2016-06-30 15:30</p>
												</div>
											</div>
											<div class="mui-card-content">
												<p>的空间疯狂的健康</p>
												<div class="media-pic-list">
													<ul>
														<li>
															<img src="../../images/login-1.png" data-preview-src="" data-preview-group="1">
														</li>
														<li>
															<img src="../../images/muwu.jpg" data-preview-src="" data-preview-group="1">
														</li>
													</ul>
												</div>
												<div class='card-location'><span class="mui-icon mui-icon-location"></span><span>新疆罗布泊303国道</span></div>
											</div>
											<div class="mui-card-footer">
												<span class="mui-icon mui-icon-location"><em>20</em></span>
												<span class="mui-icon-extra mui-icon-extra-heart"><em>5</em></span>
												<span class="mui-icon mui-icon-compose"></span>
											</div>
										</div>
									</li>
								</ul>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="personal-top" style="background-image: url(../../images/cbd.jpg);">
									<div class="head-img"><img src="../../images/food.png">
									</div>
									<div class="username">
										<!--<h4>Bwlang星</h4>-->
									</div>
								</div>
								<ul class="mui-table-view" id="mui-table-view-2">

								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/commonUtil.js"></script>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script type="text/javascript" src="../../js/mui.zoom.js"></script>
		<script type="text/javascript" src="../../js/mui.previewimage.js"></script>
		<script type="text/template" id="card-article">
			<li class="card-article">
				<a href="view/article/preview.html" articleid="$Id$" articlename="$ArticleName$">
					<div class="mui-card">
						<div class="mui-card-title">
							<p>$ArticleName$</p>
						</div>
						<div class="mui-card-header mui-card-media" style="height:40vw;background-image:url($CoverImage$)"></div>
						<div class="mui-card-content">
							<div class="mui-card-content-inner">
								<p class="userinfo">
									<em class="mui-icon mui-icon-person">$UserName$ 发表于 $CreateTimeStr$</em>
									<span class="viewcount">
									<em Id="voteCount_$Id$" class="mui-icon-extra mui-icon-extra-heart">$VoteCount$</em>
									<em Id="commentCount_$Id$" class="mui-icon mui-icon-compose">$CommentCount$</em>
								</span></p>
							</div>
						</div>
					</div>
				</a>
			</li>
		</script>
		<script type="text/template" id="card-weibo">
			<li class="card-weibo">
				<div class="mui-card">
					<div class="mui-card-header mui-card-media">
						<img class="head-img" userid="$UserId$" src="$UserHeadImage$">
						<div class="mui-media-body">
							<em class="mui-icon mui-icon-person">$UserName$</em>
							<p>发表于 $PublishTime$</p>
						</div>
					</div>
					<div class="mui-card-content">
						<p>$Description$</p>
						<div class="media-pic-list">
							$imglist$
						</div>
						$cardlocation$
					</div>
					<div class="mui-card-footer">
						<span class="mui-icon-extra votebtn mui-icon-extra-heart" weiboid='$Id$'><em>$VoteCount$</em></span>
						<span class="mui-icon mui-icon-compose" weiboid='$Id$'><em id="commentCount_$Id$">$CommentCount$</em></span>
						<span class="mui-icon mui-icon-star" weiboid='$Id$'></span>
					</div>
				</div>
			</li>
		</script>
		<script>
			mui.init();
			mui.plusReady(function() {
				//阻尼系数
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
				//获取参数
				var self = plus.webview.currentWebview();
				currentParamEntity.userid = self.userid;
				var username=self.username;
				var headimg=self.headimg;
				setUserinfo(username,headimg);
				//默认加载第一页
				getWeiboList(function(data) {});
				getArticleList(function(data) {});

				mui("#item1mobile .mui-scroll").pullToRefresh({
					up: {
						callback: function() {
							var self = this;
							getWeiboList(function(data) {
								if(data.IsSuccess == 1 && data.Data != null) {
									self.endPullUpToRefresh();
								} else {
									self.endPullUpToRefresh(true);
								}
							});
						}
					}
				});
				mui("#item2mobile .mui-scroll").pullToRefresh({
					up: {
						callback: function() {
							var self = this;
							getArticleList(function(data) {
								if(data.IsSuccess == 1 && data.Data != null) {
									self.endPullUpToRefresh();
								} else {
									self.endPullUpToRefresh(true);
								}
							});
						}
					}
				});
			});
			mui.previewImage();
		</script>
		<script type="text/javascript">
			var currentParamEntity = {
				userid: 0,
				all: {
					url: 'http://api.myautos.cn/api/Article/GetUserArticleAndWeiboListByPage',
					pageindex: 1,
					pagesize: 10
				},
				article: {
					url: 'http://api.myautos.cn/api/Article/GetUsersArticleByPage',
					pageindex: 1,
					pagesize: 10
				},
				weibo: {
					url: 'http://api.myautos.cn/api/weibo/GetUsersListByPage',
					pageindex: 1,
					pagesize: 10
				},
				current: 1,
				articleids: new Array(),
				weiboids: new Array()

			}

			function getArticleList(callback) {
				callback = callback || $.noop;
				var url = currentParamEntity.article.url;
				var data = {
					userid: currentParamEntity.userid,
					pageindex: currentParamEntity.article.pageindex,
					pagesize: currentParamEntity.article.pagesize
				};
				commonUtil.sendRequestGet(url, data, function(data) {
					if(data.IsSuccess == 1 && data.Data != null && data.Data.length > 0) {
						var list = data.Data;
						for(var i = 0; i < list.length; i++) {
							var item = list[i];
							initCard(1, item);
						}
						currentParamEntity.article.pageindex++;
					}
					return callback(data);
				});
			}

			function getWeiboList(callback) {
				callback = callback || $.noop;
				var url = currentParamEntity.weibo.url;
				var data = {
					userid: currentParamEntity.userid,
					pageindex: currentParamEntity.weibo.pageindex,
					pagesize: currentParamEntity.weibo.pagesize
				};
				commonUtil.sendRequestGet(url, data, function(data) {
					if(data.IsSuccess == 1 && data.Data != null && data.Data.length > 0) {
						var list = data.Data;
						for(var i = 0; i < list.length; i++) {
							var item = list[i];
							initCard(2, item);
						}
						currentParamEntity.weibo.pageindex++;
					}
					return callback(data);
				});
			}

			var img_1200style = 'style/weibo_1200';
			var img_600style = 'style/weibo_600';
			var img_24style = 'style/weibo_24_16';
			var img_36style = 'style/weibo_36_24';
			var articleTemplate = $('script[id="card-article"]').html();
			var weiboTemplate = $('script[id="card-weibo"]').html();
			///填充内容
			function initCard(entityType, item) {
				if(entityType == 1) {
					var article = item;
					if($.inArray(article.Id, currentParamEntity.articleids) == -1) {
						article.CoverImage = article.CoverImage.replace("style/articlecover_36_24", "style/weibo_600")
						var imgHtmlStr = articleTemplate.temp(article);
						$("#mui-table-view-2").append(imgHtmlStr);
						currentParamEntity.articleids.push(article.Id);
					}
				}

				if(entityType == 2) {
					var weibo = item;
					if($.inArray(weibo.Id, currentParamEntity.weiboids) == -1) {
						var imgHtmlStr = "";
						var imgs = weibo.ContentValue.split(',');
						if(imgs.length > 1) {
							//多图
							imgHtmlStr += "<ul>";
							for(var j = 0; j < imgs.length; j++) {
								imgHtmlStr += '<li><img src="' + imgs[j] + '" data-preview-src="' + imgs[j].replace(img_24style, img_1200style) + '" data-preview-group="' + weibo.Id + '"></li>';
							}
							imgHtmlStr += "</ul>";
						} else {
							imgHtmlStr = '<img src="' + imgs[0].replace(img_24style, img_36style) + '" class="bigimage" data-preview-src="' + imgs[0].replace(img_24style, img_1200style) + '" data-preview-group="' + item.Id + '">';
						}
						weibo.imglist = imgHtmlStr;
						//显示地理位置
						weibo.cardlocation = "";
						if(weibo.LocationText != "" && weibo.Longitude != "" && weibo.Lantitude != "") {
							var lbsStr = "<div weiboid='" + weibo.Id + "' class='card-location'><span class='mui-icon mui-icon-location'></span><span>" + weibo.LocationText + "</span></div>";
							weibo.cardlocation = lbsStr;
						}
						var cardStr = weiboTemplate.temp(weibo);
						$("#mui-table-view-1").append(cardStr);
						currentParamEntity.weiboids.push(weibo.Id);
					}
				}
			}

			//
			function setUserinfo(username,headimg) {
				$("#header .mui-title").html(username);
				$(".personal-top .head-img img").attr("src", headimg);
			}
		</script>
	</body>
</html>